version: '3.4'

services:

  takserver_initialization:
    image: "pvarki/takserver:4.7-RELEASE-32${DOCKER_TAG_EXTRA}"
    build:
      context: .
      dockerfile: Dockerfile
    env_file:
      - 'takserver.env'
    depends_on:
      - "takdb"
    networks:
      - taknet
    volumes:
      - 'takserver_data:/mnt/tak/'
    command: ./opt/scripts/firstrun.sh

  takserver_messaging:
    image: "pvarki/takserver:4.7-RELEASE-32${DOCKER_TAG_EXTRA}"
    build:
      context: .
      dockerfile: Dockerfile
    env_file:
      - 'takserver.env'
    depends_on:
      - "takdb"
    volumes:
      - 'takserver_data:/mnt/tak/'
    networks:
      - taknet
    ports:
      - '18443:8443'
      - '18444:8444'
      - '18446:8446'
      - '18089:8089'
      - '18080:8080'
    command: ./opt/scripts/start-messaging.sh

  takserver_api:
    image: "pvarki/takserver:4.7-RELEASE-32${DOCKER_TAG_EXTRA}"
    build:
      context: .
      dockerfile: Dockerfile
    env_file:
      - 'takserver.env'
    depends_on:
      - "takserver_messaging"
      - "takdb"
    volumes:
      - 'takserver_data:/mnt/tak/'
    network_mode: "service:takserver_messaging"
    command: ./opt/scripts/start-api.sh

  takdb:
    image: postgis/postgis:15-3.3
    networks:
      - taknet
    env_file:
      - 'takserver.env'
    volumes:
      - 'takdb_data:/var/lib/postgresql/data'

networks:
  taknet:

volumes:
  takserver_data:
    driver: local
  takdb_data:
    driver: local
