kind: containerapp
location: westeurope
name: takserver
resourceGroup: datadogexample
type: Microsoft.App/containerApps
tags:
  tagname: value
properties:
  managedEnvironmentId: $ENVIRONMENTID
  configuration:
    activeRevisionsMode: Single
    ingress:
      external: true
      allowInsecure: true
      targetPort: 8080
      traffic:
        - latestRevision: true
          weight: 100
      transport: Auto
  template:
    containers:
      - name: takserver_messaging
        image: pvarki/takserver:4.7-RELEASE-dev
        resources:
          cpu: 2
          memory: 4Gi
        command:
          - ./opt/scripts/start-tak.sh 
          - messaging
        env:
          - name: ADMIN_CERT_PASS
            value: Password12341
          - name: TAKSERVER_CERT_PASS
            value: Password12341
          - name: CA_PASS
            value: CAPassword123
        volumeMounts:
          - mountPath: /opt/tak/data/logs
            volumeName: takserver_logs
          - mountPath: /opt/tak/data/certs
            volumeName: takserver_certs
      - name: takserver_api
        image: pvarki/takserver:4.7-RELEASE-dev
        resources:
          cpu: 2
          memory: 4Gi
        command:
          - ./opt/scripts/start-tak.sh 
          - api
        env:
          - name: ADMIN_CERT_PASS
            value: Password12341
          - name: TAKSERVER_CERT_PASS
            value: Password12341
          - name: CA_PASS
            value: CAPassword123
        volumeMounts:
          - mountPath: /opt/tak/data/logs
            volumeName: takserver_logs
          - mountPath: /opt/tak/data/certs
            volumeName: takserver_certs
      - name: takserver_pluginmanager
        image: pvarki/takserver:4.7-RELEASE-dev
        resources:
          cpu: 2
          memory: 4Gi
        command:
          - ./opt/scripts/start-tak.sh 
          - pm
        env:
          - name: ADMIN_CERT_PASS
            value: Password12341
          - name: TAKSERVER_CERT_PASS
            value: Password12341
          - name: CA_PASS
            value: CAPassword123
        volumeMounts:
          - mountPath: /opt/tak/data/logs
            volumeName: takserver_logs
          - mountPath: /opt/tak/data/certs
            volumeName: takserver_certs
      - name: takdb
        image: postgis/postgis:15-3.3
        resources:
          cpu: 2
          memory: 4Gi
        volumeMounts:
          - mountPath: /var/lib/postgresql/data
            volumeName: takdb
        env:
          - name: POSTGRES_DB
            value: cot
          - name: POSTGRES_USER
            value: martiuser
          - name: POSTGRES_ADDRESS
            value: takdb
          - name: POSTGRES_PASSWORD
            value: Password12341
    scale:
      minReplicas: 1
      maxReplicas: 1


    initContainers:
      - name: takserver_init
        image: pvarki/takserver:4.7-RELEASE-dev
        resources:
          cpu: 2
          memory: 4Gi
        command:
          - ./opt/scripts/firstrun.sh
        env:
          - name: POSTGRES_PASSWORD
            value: Password12341
          - name: ADMIN_CERT_PASS
            value: Password12341
          - name: TAKSERVER_CERT_PASS
            value: Password12341
          - name: COUNTRY
            value: fi
          - name: CA_NAME
            value: Test-CA
          - name: CA_PASS
            value: CAPassword123
          - name: STATE
            value: Uusimaa
          - name: CITY
            value: Helsinki
          - name: ORGANIZATION
            value: Test
          - name: ORGANIZATIONAL_UNIT
            value: Test

  volumes:
    - name: takdb
      storageType: AzureFile
      storageName: takdb
    - name: takserver_logs
      storageType: AzureFile
      storageName: takserver_logs
    - name: takserver_certs
      storageType: AzureFile
      storageName: takserver_certs